const videoElement=document.getElementById("video"),canvasElement=document.getElementById("canvas"),canvasCtx=canvasElement.getContext("2d"),circle=document.getElementById("circle"),circle2=document.getElementById("circle2"),zone=document.getElementById("zone"),height=document.getElementById("zoneValue"),customHeight=document.getElementById("customHeight");let canvasOffset=null;const pauseButton=document.getElementById("pauseButton"),hFlip=document.getElementById("hFlip"),trackingConfidence=document.getElementById("trackingConfidence"),detectionConfidence=document.getElementById("detectionConfidence"),complexModel=document.getElementById("complexModel");let paused=!1,cameraRenderer=!0,horizontalFlip=!0,hand0={},hand1={},lastHandValue0=-1,lastHandValue1=-1,zoneHeight=200,zoneLevels=zoneHeight/6;function clamp(e,t,n){return e<t?t:e>n?n:e}function getSavedOrDefault(e,t){const n=window.localStorage.getItem(e);return null===n?t:n}function updateInput(e){zoneHeight=Number(getSavedOrDefault("customHeight",zoneHeight)),zoneLevels=zoneHeight/6,customHeight.value=zoneHeight,zone.style.height=zoneHeight+"px",hFlip.textContent=e.selfieMode?"Unflip Camera Horizontally":"Flip Camera Horizontally",trackingConfidence.value=e.minTrackingConfidence,detectionConfidence.value=e.minDetectionConfidence,complexModel.value=e.modelComplexity}function initializeListeners(){customHeight.addEventListener("change",(()=>{const e=Number(clamp(customHeight.value,1,canvasElement.height));zoneHeight=e,zoneLevels=zoneHeight/6,zone.style.height=zoneHeight+"px",customHeight.value=e,window.localStorage.setItem("customHeight",e)})),pauseButton.addEventListener("click",(()=>{paused=!paused,pauseButton.textContent=paused?"Paused":"Running"})),cameraButton.addEventListener("click",(()=>{cameraRenderer=!cameraRenderer,cameraButton.textContent=cameraRenderer?"Disable Camera Renderer":"Enable Camera Renderer"})),hFlip.addEventListener("click",(()=>{horizontalFlip=!horizontalFlip,hFlip.textContent=horizontalFlip?"Unflip Camera Horizontally":"Flip Camera Horizontally",hands.setOptions({selfieMode:horizontalFlip}),window.localStorage.setItem("hFlip",horizontalFlip)})),trackingConfidence.addEventListener("change",(()=>{const e=Number(clamp(trackingConfidence.value,.05,1));hands.setOptions({minTrackingConfidence:e}),trackingConfidence.value=e,window.localStorage.setItem("trackingConfidence",e)})),detectionConfidence.addEventListener("change",(()=>{const e=Number(clamp(detectionConfidence.value,.05,1));hands.setOptions({minDetectionConfidence:e}),detectionConfidence.value=e,window.localStorage.setItem("detectionConfidence",e)})),complexModel.addEventListener("change",(()=>{const e=Number(clamp(Math.round(complexModel.value),0,1));hands.setOptions({modelComplexity:e}),complexModel.value=e,window.localStorage.setItem("complexModel",e)}))}function getAirZoneValue(e){const t=e.y*canvasElement.height;return t>zoneHeight?-1:5-Math.floor(t/zoneLevels)}function updateHands(){const e=getAirZoneValue(hand0),t=getAirZoneValue(hand1);e==lastHandValue0&&t==lastHandValue1||updateTouches(e,t),showResults(e,t),lastHandValue0=e,lastHandValue1=t}function showResults(e,t){cameraRenderer&&(canvasOffset=canvas.getBoundingClientRect(),zone.style.left=canvasOffset.left+"px",zone.style.width=canvasOffset.width+"px",null!=hand0?.side&&(circle.style.transform=setStyleTransform(hand0)),null!=hand1?.side&&(circle2.style.transform=setStyleTransform(hand1))),height.textContent=e+", "+t}function setStyleTransform(e){return"translate3d("+(canvasOffset.left+e.x*canvasOffset.width)+"px,"+(canvasOffset.top+e.y*canvasOffset.height-canvasOffset.top)+"px, 0)"}function onResults(e){if(e.multiHandLandmarks){for(let t=0;t<e.multiHandLandmarks.length;t++){let n={};const a=e.multiHandLandmarks[t];for(const[a,o]of Object.entries(e.multiHandedness))if(o.index===t){n.side=o.label;break}a.length>9&&(n.x=(a[0].x+a[9].x)/2,n.y=(a[0].y+a[9].y)/2,0===t?hand0=n:1===t&&(hand1=n))}updateHands()}if(cameraRenderer&&e.multiHandLandmarks){canvasCtx.save(),canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height),canvasCtx.drawImage(e.image,0,0,canvasElement.width,canvasElement.height);for(const t of e.multiHandLandmarks)drawConnectors(canvasCtx,t,HAND_CONNECTIONS,{color:"#00FF00",lineWidth:2}),drawLandmarks(canvasCtx,t,{color:"#0000FF",lineWidth:2});canvasCtx.restore()}}var lastState=[0,0,0,0,0,0];function updateTouches(e,t){if(!paused)try{let n=[0,0,0,0,0,0];e>-1&&(n[e]=1),t>-1&&(n[t]=1),n!==lastState&&throttledSendKeys(n),lastState=n}catch(e){alert(e)}}const throttle=(e,t)=>{var n=!0,a=null;return function o(){var l=this;n?(n=!1,setTimeout((function(){n=!0,a&&o.apply(l)}),t),a?(e.apply(this,a),a=null):e.apply(this,arguments)):a=arguments}},sendKeys=e=>{wsConnected&&ws.send("d"+e.join(""))},throttledSendKeys=throttle(sendKeys,10);var ws=null,wsTimeout=0,wsConnected=!1;const wsConnect=()=>{(ws=new WebSocket("ws://"+location.host+"/ws")).binaryType="arraybuffer",ws.onopen=()=>{ws.send("alive?")},ws.onmessage=e=>{e.data.byteLength?updateLed(e.data):"alive"==e.data&&(wsTimeout=0,wsConnected=!0)}},wsWatch=()=>{if(wsTimeout++>2)return wsTimeout=0,ws.close(),wsConnected=!1,void wsConnect();wsConnected&&ws.send("alive?")},hands=new Hands({locateFile:e=>(console.log("looking for:",`lib/hands/${e}`),`lib/hands/${e}`)}),params={selfieMode:"true"===getSavedOrDefault("hFlip","true"),maxNumHands:2,minTrackingConfidence:Number(getSavedOrDefault("trackingConfidence",.1)),minDetectionConfidence:Number(getSavedOrDefault("detectionConfidence",.25)),modelComplexity:Number(getSavedOrDefault("complexModel",0))};updateInput(params),initializeListeners(),hands.setOptions(params),hands.onResults(onResults);const camera=new Camera(videoElement,{onFrame:async()=>{await hands.send({image:videoElement})},facingMode:"user",width:canvasElement.width,height:canvasElement.height});wsConnect(),setInterval(wsWatch,1e3),camera.start();
