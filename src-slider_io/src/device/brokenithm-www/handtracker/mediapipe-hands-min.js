import{HandLandmarker,FilesetResolver,DrawingUtils}from"./lib/tasks-vision/vision_bundle.mjs";const videoElement=document.getElementById("video"),canvasElement=document.getElementById("canvas"),canvasCtx=canvasElement.getContext("2d"),circle=document.getElementById("circle"),circle2=document.getElementById("circle2"),zone=document.getElementById("zone"),height=document.getElementById("zoneValue"),customHeight=document.getElementById("customHeight");let canvasOffset=null;const pauseButton=document.getElementById("pauseButton"),trackingConfidence=document.getElementById("trackingConfidence"),detectionConfidence=document.getElementById("detectionConfidence"),handPresenceConfidence=document.getElementById("handPresenceConfidence");let handLandmarker,drawingUtils,lastVideoTime=-1,paused=!1,handDetectionRender=!0,rightHand={},leftHand={},lastRightHandAirValue=-1,lastLeftHandAirValue=-1,zoneHeight=200,zoneLevels=zoneHeight/6;function clamp(e,n,t){return e<n?n:e>t?t:e}function getSavedOrDefault(e,n){const t=window.localStorage.getItem(e);return null===t?n:t}function updateInput(e){zoneHeight=Number(getSavedOrDefault("customHeight",zoneHeight)),zoneLevels=zoneHeight/6,customHeight.value=zoneHeight,zone.style.height=zoneHeight+"px",trackingConfidence.value=e.minTrackingConfidence,detectionConfidence.value=e.minHandDetectionConfidence,handPresenceConfidence.value=e.minHandPresenceConfidence}function initializeListeners(){customHeight.addEventListener("change",(()=>{const e=Number(clamp(customHeight.value,1,canvasElement.height));zoneHeight=e,zoneLevels=zoneHeight/6,zone.style.height=zoneHeight+"px",customHeight.value=e,window.localStorage.setItem("customHeight",e)})),pauseButton.addEventListener("click",(()=>{paused=!paused,pauseButton.textContent=paused?"Paused":"Running"})),cameraButton.addEventListener("click",(()=>{handDetectionRender=!handDetectionRender,cameraButton.textContent=handDetectionRender?"Disable Hand Detection Render":"Enable Hand Detection Render"})),trackingConfidence.addEventListener("change",(async()=>{const e=Number(clamp(trackingConfidence.value,.05,1));trackingConfidence.value=e,window.localStorage.setItem("minTrackingConfidence",e),handLandmarker.setOptions({minTrackingConfidence:e})})),detectionConfidence.addEventListener("change",(async()=>{const e=Number(clamp(detectionConfidence.value,.05,1));detectionConfidence.value=e,window.localStorage.setItem("minHandDetectionConfidence",e),handLandmarker.setOptions({minHandDetectionConfidence:e})})),handPresenceConfidence.addEventListener("change",(async()=>{const e=Number(clamp(handPresenceConfidence.value,.05,1));handPresenceConfidence.value=e,window.localStorage.setItem("minHandPresenceConfidence",e),handLandmarker.setOptions({minHandPresenceConfidence:e})}))}function getAirZoneValue(e){const n=e.y*canvasElement.height;return n>zoneHeight?-1:5-Math.floor(n/zoneLevels)}function updateHands(){const e=getAirZoneValue(rightHand),n=getAirZoneValue(leftHand);e==lastRightHandAirValue&&n==lastLeftHandAirValue||updateTouches(e,n),showResults(e,n),lastRightHandAirValue=e,lastLeftHandAirValue=n}function showResults(e,n){handDetectionRender&&(canvasOffset=canvas.getBoundingClientRect(),zone.style.left=canvasOffset.left+"px",zone.style.width=canvasOffset.width+"px",null!=rightHand?.sideIndex&&(circle.style.transform=setStyleTransform(rightHand)),null!=leftHand?.sideIndex&&(circle2.style.transform=setStyleTransform(leftHand))),height.textContent=e+", "+n}function setStyleTransform(e){return"translate3d("+(canvasOffset.left+e.x*canvasOffset.width)+"px,"+(canvasOffset.top+e.y*canvasOffset.height-canvasOffset.top)+"px, 0)"}function onResults(e){if(e.landmarks&&e.landmarks.length>0){for(let n=0;n<e.landmarks.length;n++){let t={};const a=e.landmarks[n];if(e.handedness&&e.handedness.length>0)for(const a of e.handedness){let e=!1;for(const i of a)if(i.index==n){t.sideIndex=i.index,t.name=i.categoryName,e=!0;break}if(e)break}else console.warn("Result Landmarks exists, but no handednesses information exists.",e);a.length>9&&(t.x=(a[0].x+a[9].x)/2,t.y=(a[0].y+a[9].y)/2,1===t.sideIndex?leftHand=t:rightHand=t)}updateHands()}if(handDetectionRender&&e.landmarks){canvasCtx.save(),canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);for(const n of e.landmarks)drawingUtils.drawConnectors(n,HandLandmarker.HAND_CONNECTIONS,{color:"#00AA00",lineWidth:2}),drawingUtils.drawLandmarks(n,{color:"#00FF00",lineWidth:1});canvasCtx.restore()}}var lastState=[0,0,0,0,0,0];function updateTouches(e,n){if(!paused)try{let t=[0,0,0,0,0,0];e>-1&&(t[e]=1),n>-1&&(t[n]=1),t!==lastState&&throttledSendKeys(t),lastState=t}catch(e){alert(e)}}const throttle=(e,n)=>{var t=!0,a=null;return function i(){var d=this;t?(t=!1,setTimeout((function(){t=!0,a&&i.apply(d)}),n),a?(e.apply(this,a),a=null):e.apply(this,arguments)):a=arguments}},sendKeys=e=>{wsConnected&&ws.send("d"+e.join(""))},throttledSendKeys=throttle(sendKeys,10);var ws=null,wsTimeout=0,wsConnected=!1;const wsConnect=()=>{(ws=new WebSocket("ws://"+location.host+"/ws")).binaryType="arraybuffer",ws.onopen=()=>{ws.send("alive?")},ws.onmessage=e=>{e.data.byteLength?updateLed(e.data):"alive"==e.data&&(wsTimeout=0,wsConnected=!0)}},wsWatch=()=>{if(wsTimeout++>2)return wsTimeout=0,ws.close(),wsConnected=!1,void wsConnect();wsConnected&&ws.send("alive?")},params={numHands:2,minTrackingConfidence:Number(getSavedOrDefault("minTrackingConfidence",.1)),minHandPresenceConfidence:Number(getSavedOrDefault("minHandPresenceConfidence",.5)),minHandDetectionConfidence:Number(getSavedOrDefault("minHandDetectionConfidence",.25)),baseOptions:{modelAssetPath:"lib/hand-landmarker_float_16/hand_landmarker.task",delegate:"GPU"},runningMode:"VIDEO"};async function initializeHandTracking(){updateInput(params),initializeListeners(),drawingUtils=new DrawingUtils(canvasCtx);const e=await FilesetResolver.forVisionTasks("lib/tasks-vision/wasm");handLandmarker=await HandLandmarker.createFromOptions(e,params)}function startCamera(){if(!navigator.mediaDevices?.getUserMedia)return console.error("getUserMedia() is not supported by your browser"),void alert("getUserMedia() is not supported by your browser");if(!handLandmarker)return void console.error("hand landmarker failed to be created...");navigator.mediaDevices.getUserMedia({video:!0}).then((e=>{videoElement.addEventListener("loadeddata",mainLoop),videoElement.addEventListener("loadedmetadata",(()=>{canvasElement.height=videoElement.videoHeight,canvasElement.width=videoElement.videoWidth})),videoElement.srcObject=e}))}function mainLoop(){let e=performance.now();if(lastVideoTime!==videoElement.currentTime){lastVideoTime=videoElement.currentTime,onResults(handLandmarker.detectForVideo(videoElement,e))}window.requestAnimationFrame(mainLoop)}wsConnect(),setInterval(wsWatch,1e3),initializeHandTracking().then((()=>{startCamera()}));
