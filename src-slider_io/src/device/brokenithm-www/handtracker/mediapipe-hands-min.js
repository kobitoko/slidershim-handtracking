const videoElement=document.getElementById("video"),canvasElement=document.getElementById("canvas"),canvasCtx=canvasElement.getContext("2d"),circle=document.getElementById("circle"),circle2=document.getElementById("circle2"),zone=document.getElementById("zone"),height=document.getElementById("zoneValue"),customHeight=document.getElementById("customHeight");let canvasOffset=null;const pauseButton=document.getElementById("pauseButton"),hFlip=document.getElementById("hFlip"),trackingConfidence=document.getElementById("trackingConfidence"),detectionConfidence=document.getElementById("detectionConfidence"),complexModel=document.getElementById("complexModel");let paused=!1,cameraRenderer=!0,horizontalFlip=!0,hand0={},hand1={},lastHandValue0=-1,lastHandValue1=-1,zoneHeight=250,zoneLevels=zoneHeight/6;function clamp(e,n,t){return e<n?n:e>t?t:e}function initializeListeners(){zone.style.height=zoneHeight+"px",customHeight.addEventListener("change",(()=>{const e=Number(clamp(customHeight.value,1,canvasElement.height));zoneHeight=e,zoneLevels=zoneHeight/6,zone.style.height=zoneHeight+"px",customHeight.value=e})),pauseButton.addEventListener("click",(()=>{paused=!paused,pauseButton.textContent=paused?"Paused":"Running"})),cameraButton.addEventListener("click",(()=>{cameraRenderer=!cameraRenderer,cameraButton.textContent=cameraRenderer?"Disable Camera Renderer":"Enable Camera Renderer"})),hFlip.addEventListener("click",(()=>{horizontalFlip=!horizontalFlip,hFlip.textContent=horizontalFlip?"Camera Flipped Horizontally":"Camera Not Flipped Horizontally",hands.setOptions({selfieMode:horizontalFlip})})),trackingConfidence.addEventListener("change",(()=>{const e=Number(clamp(trackingConfidence.value,.05,1));hands.setOptions({minTrackingConfidence:e}),trackingConfidence.value=e})),detectionConfidence.addEventListener("change",(()=>{const e=Number(clamp(detectionConfidence.value,.05,1));hands.setOptions({minDetectionConfidence:e}),detectionConfidence.value=e})),complexModel.addEventListener("change",(()=>{const e=Number(clamp(Math.round(complexModel.value),0,1));hands.setOptions({modelComplexity:e}),complexModel.value=e}))}function getAirZoneValue(e){const n=e.y*canvasElement.height;return n>zoneHeight?-1:5-Math.floor(n/zoneLevels)}function updateHands(){const e=getAirZoneValue(hand0),n=getAirZoneValue(hand1);e==lastHandValue0&&n==lastHandValue1||updateTouches(e,n),showResults(e,n),lastHandValue0=e,lastHandValue1=n}function showResults(e,n){cameraRenderer&&(canvasOffset=canvas.getBoundingClientRect(),zone.style.left=canvasOffset.left+"px",zone.style.width=canvasOffset.width+"px",null!=hand0?.side&&(circle.style.transform=setStyleTransform(hand0)),null!=hand1?.side&&(circle2.style.transform=setStyleTransform(hand1))),height.textContent=e+", "+n}function setStyleTransform(e){return"translate3d("+(canvasOffset.left+e.x*canvasOffset.width)+"px,"+(canvasOffset.top+e.y*canvasOffset.height-canvasOffset.top)+"px, 0)"}function onResults(e){if(e.multiHandLandmarks){for(let n=0;n<e.multiHandLandmarks.length;n++){let t={};const a=e.multiHandLandmarks[n];for(const[a,s]of Object.entries(e.multiHandedness))if(s.index===n){t.side=s.label;break}a.length>9&&(t.x=(a[0].x+a[9].x)/2,t.y=(a[0].y+a[9].y)/2,0===n?hand0=t:1===n&&(hand1=t))}updateHands()}if(cameraRenderer&&e.multiHandLandmarks){canvasCtx.save(),canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height),canvasCtx.drawImage(e.image,0,0,canvasElement.width,canvasElement.height);for(const n of e.multiHandLandmarks)drawConnectors(canvasCtx,n,HAND_CONNECTIONS,{color:"#00FF00",lineWidth:2}),drawLandmarks(canvasCtx,n,{color:"#0000FF",lineWidth:2});canvasCtx.restore()}}var lastState=[0,0,0,0,0,0];function updateTouches(e,n){if(!paused)try{let t=[0,0,0,0,0,0];e>-1&&(t[e]=1),n>-1&&(t[n]=1),t!==lastState&&throttledSendKeys(t),lastState=t}catch(e){alert(e)}}const throttle=(e,n)=>{var t=!0,a=null;return function s(){var o=this;t?(t=!1,setTimeout((function(){t=!0,a&&s.apply(o)}),n),a?(e.apply(this,a),a=null):e.apply(this,arguments)):a=arguments}},sendKeys=e=>{wsConnected&&ws.send("d"+e.join(""))},throttledSendKeys=throttle(sendKeys,10);var ws=null,wsTimeout=0,wsConnected=!1;const wsConnect=()=>{(ws=new WebSocket("ws://"+location.host+"/ws")).binaryType="arraybuffer",ws.onopen=()=>{ws.send("alive?")},ws.onmessage=e=>{e.data.byteLength?updateLed(e.data):"alive"==e.data&&(wsTimeout=0,wsConnected=!0)}},wsWatch=()=>{if(wsTimeout++>2)return wsTimeout=0,ws.close(),wsConnected=!1,void wsConnect();wsConnected&&ws.send("alive?")},hands=new Hands({locateFile:e=>(console.log("looking for:",`lib/hands/${e}`),`lib/hands/${e}`)});hands.setOptions({selfieMode:!0,maxNumHands:2,modelComplexity:1,minDetectionConfidence:.4,minTrackingConfidence:.4}),hands.onResults(onResults);const camera=new Camera(videoElement,{onFrame:async()=>{await hands.send({image:videoElement})},facingMode:"user",width:canvasElement.width,height:canvasElement.height});initializeListeners(),wsConnect(),setInterval(wsWatch,1e3),camera.start();
