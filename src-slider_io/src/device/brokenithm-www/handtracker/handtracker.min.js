const video=document.getElementById("video"),canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),circle=document.getElementById("circle"),circle2=document.getElementById("circle2"),zone=document.getElementById("zone"),height=document.getElementById("zoneValue"),customHeight=document.getElementById("customHeight");let canvasOffset=null;const detectionsPerSeconds=document.getElementById("detectionsPerSeconds"),pauseButton=document.getElementById("pauseButton"),hFlip=document.getElementById("hFlip"),scoreThreshold=document.getElementById("scoreThreshold"),iouThreshold=document.getElementById("iouThreshold"),modelType=document.getElementById("modelType"),modelSize=document.getElementById("modelSize"),modelParams={flipHorizontal:!0,outputStride:16,imageScaleFactor:1,maxNumBoxes:3,iouThreshold:.2,scoreThreshold:.35,modelType:"ssd320fpnlite",modelSize:"large"};let paused=!1,cameraRenderer=!0,horizontalFlip=!0,hand0={},hand1={},lastHandValue0=-1,lastHandValue1=-1,zoneHeight=250,zoneLevels=zoneHeight/6;function updateModel(e){model.setModelParameters(e)}function initializeListeners(){window.addEventListener("beforeunload",(()=>{null!=model&&(console.info("Disposing the model instance."),model.dispose())})),pauseButton.addEventListener("click",(()=>{paused=!paused,pauseButton.textContent=paused?"Paused":"Running"})),cameraButton.addEventListener("click",(()=>{cameraRenderer=!cameraRenderer,cameraButton.textContent=cameraRenderer?"Disable Camera Renderer":"Enable Camera Renderer"})),hFlip.addEventListener("click",(()=>{horizontalFlip=!horizontalFlip,hFlip.textContent=horizontalFlip?"Camera Flipped Horizontally":"Camera Not Flipped Horizontally",updateModel({flipHorizontal:horizontalFlip})})),scoreThreshold.addEventListener("change",(()=>{updateModel({scoreThreshold:scoreThreshold.value})})),iouThreshold.addEventListener("change",(()=>{updateModel({iouThreshold:iouThreshold.value})})),modelType.addEventListener("change",(()=>{updateModel({modelType:modelType.value})})),modelSize.addEventListener("change",(()=>{updateModel({modelSize:modelSize.value})}))}function startVideo(){handTrack.startVideo(video).then((e=>{console.info("Video started",e.msg),e?(console.info("Tracking..."),zone.style.height=zoneHeight+"px",customHeight.addEventListener("change",(()=>{zoneHeight=customHeight.value,zoneLevels=zoneHeight/6,zone.style.height=zoneHeight+"px"})),runDetection()):console.error("Please enable video.")}))}function runDetection(){model.detect(video).then((e=>{for(var t=0;t<e.length;t++)e[t]?.bbox&&"face"!==e[t]?.label&&(detection=getHandCenter(t,e[t].bbox),-1!==detection.id&&(0===t?hand0=detection:hand1=detection));cameraRenderer&&model.renderPredictions(e,canvas,context,video);const n=getAirZoneValue0(),o=getAirZoneValue1();n==lastHandValue0&&o==lastHandValue1||updateTouches(),showResults(n,o),lastHandValue0=n,lastHandValue1=o,requestAnimationFrame(runDetection)}))}function showResults(e,t){canvasOffset=canvas.getBoundingClientRect(),zone.style.left=canvasOffset.left+"px",zone.style.width=canvasOffset.width+"px";null!=hand0?.id&&(circle.style.transform="translate3d("+(canvasOffset.left+hand0.x)+"px,"+(canvasOffset.top+hand0.y-15)+"px,0)"),null!=hand1?.id&&(circle2.style.transform="translate3d("+(canvasOffset.left+hand1.x)+"px,"+(canvasOffset.top+hand1.y-15)+"px,0)"),height.textContent=e+", "+t,detectionsPerSeconds.textContent=model.getFPS()}function getHandCenter(e,t){if(Array.isArray(t)&&4===t.length){return{id:e,x:t[0]+t[2]/2,y:t[1]+t[3]/2}}return{id:-1,x:0,y:0}}function isAnyInAirZone(){return(hand0.y>hand1.y?hand1.y:hand0.y)<=zoneHeight}function getAirZoneValue0(){return hand0.y>zoneHeight?-1:5-Math.floor(hand0.y/zoneLevels)}function getAirZoneValue1(){return hand1.y>zoneHeight?-1:5-Math.floor(hand1.y/zoneLevels)}handTrack.load(modelParams).then((e=>{console.info("Model loaded."),initializeListeners(),model=e,message=document.getElementById("message"),message.style.display="none",startVideo(),wsConnect(),setInterval(wsWatch,1e3)}));var lastState=[0,0,0,0,0,0];function updateTouches(){if(!paused)try{let e=[0,0,0,0,0,0];const t=getAirZoneValue0(),n=getAirZoneValue1();t>-1&&(e[t]=1),n>-1&&(e[n]=1),e!==lastState&&throttledSendKeys(e),lastState=e}catch(e){alert(e)}}const throttle=(e,t)=>{var n=!0,o=null;return function a(){var d=this;n?(n=!1,setTimeout((function(){n=!0,o&&a.apply(d)}),t),o?(e.apply(this,o),o=null):e.apply(this,arguments)):o=arguments}},sendKeys=e=>{wsConnected&&ws.send("d"+e.join(""))},throttledSendKeys=throttle(sendKeys,10);var ws=null,wsTimeout=0,wsConnected=!1;const wsConnect=()=>{(ws=new WebSocket("ws://"+location.host+"/ws")).binaryType="arraybuffer",ws.onopen=()=>{ws.send("alive?")},ws.onmessage=e=>{e.data.byteLength?updateLed(e.data):"alive"==e.data&&(wsTimeout=0,wsConnected=!0)}},wsWatch=()=>{if(wsTimeout++>2)return wsTimeout=0,ws.close(),wsConnected=!1,void wsConnect();wsConnected&&ws.send("alive?")};
